<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Website Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black min-h-[100dvh] flex flex-col overflow-hidden">
    <header class="flex items-center px-4 py-2 bg-gray-100 flex-shrink-0">
        <div class="flex">
            <div class="w-3 h-3 rounded-full bg-red-500 mr-1"></div>
            <div class="w-3 h-3 rounded-full bg-yellow-500 mr-1"></div>
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
        </div>
        <div class="flex-1"></div>
        <button id="preview-btn" class="px-4 py-1 bg-blue-500 text-white border border-blue-500">Preview</button>
        <button id="code-btn" class="ml-2 px-4 py-1 bg-white border border-gray-300">Code</button>
        <button id="download-btn" class="ml-4 px-4 py-1 bg-green-500 text-white">Download</button>
    </header>
    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 flex flex-col bg-gray-200 overflow-hidden">
            <button id="new-project-btn" class="m-4 px-4 py-2 bg-blue-500 text-white rounded">+ New Project</button>
            <ul id="project-list" class="flex-1 overflow-y-auto"></ul>
            <button id="settings-btn" class="mt-auto p-4 text-center text-xl">⚙️</button>
        </aside>
        <main class="flex-1 overflow-hidden" id="content"></main>
    </div>
    <footer class="flex-shrink-0 flex items-center px-4 py-2 bg-gray-100">
        <textarea id="input" class="flex-1 p-2 border border-gray-300 rounded resize-vertical" placeholder="Describe your website or changes..."></textarea>
        <button id="send-btn" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded">Send</button>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded shadow-lg w-96">
            <h2 class="text-xl mb-4">Settings</h2>
            <label class="block mb-2">API URL:</label>
            <input id="api-url" type="text" class="w-full p-2 border border-gray-300 rounded mb-4">
            <label class="block mb-2">API Key:</label>
            <input id="api-key" type="password" class="w-full p-2 border border-gray-300 rounded mb-4">
            <label class="block mb-2">Model ID:</label>
            <input id="model-id" type="text" class="w-full p-2 border border-gray-300 rounded mb-4">
            <button id="close-modal" class="px-4 py-2 bg-blue-500 text-white rounded">Close</button>
        </div>
    </div>

    <script>
        const SYSTEM_PROMPT = "You are a web developer. Output ONLY raw HTML code...";

        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let currentId = localStorage.getItem('currentId');
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            apiUrl: "https://openrouter.ai/api/v1/chat/completions",
            apiKey: "",
            model: "deepseek/deepseek-r1:free"
        };
        let mode = 'preview';

        const projectList = document.getElementById('project-list');
        const content = document.getElementById('content');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send-btn');
        const newProjectBtn = document.getElementById('new-project-btn');
        const previewBtn = document.getElementById('preview-btn');
        const codeBtn = document.getElementById('code-btn');
        const downloadBtn = document.getElementById('download-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const modal = document.getElementById('settings-modal');
        const apiUrlInput = document.getElementById('api-url');
        const apiKeyInput = document.getElementById('api-key');
        const modelIdInput = document.getElementById('model-id');
        const closeModal = document.getElementById('close-modal');

        function save() {
            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('currentId', currentId);
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function getCurrentProject() {
            return projects.find(p => p.id === currentId);
        }

        function getCurrentHtml() {
            const proj = getCurrentProject();
            if (!proj || proj.messages.length === 0) return '';
            const last = proj.messages[proj.messages.length - 1];
            if (last.role === 'assistant') return last.content;
            return '';
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function escapeForSrcdoc(str) {
            return str.replace(/"/g, '&quot;');
        }

        function renderContent() {
            const html = getCurrentHtml();
            if (mode === 'preview') {
                content.innerHTML = `<iframe class="w-full h-full border-none" srcdoc="${escapeForSrcdoc(html)}"></iframe>`;
            } else {
                content.innerHTML = `<pre class="w-full h-full overflow-auto p-4 bg-white"><code>${escapeHtml(html)}</code></pre>`;
            }
        }

        function renderProjects() {
            projectList.innerHTML = '';
            projects.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p.name;
                li.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-300');
                if (p.id === currentId) li.classList.add('bg-blue-100');
                li.onclick = () => setCurrent(p.id);
                projectList.appendChild(li);
            });
        }

        function setCurrent(id) {
            currentId = id;
            save();
            renderProjects();
            renderContent();
        }

        function createNewProject() {
            const id = Date.now().toString();
            projects.push({ id, name: 'Untitled', messages: [] });
            setCurrent(id);
        }

        function updateMode(newMode) {
            mode = newMode;
            if (mode === 'preview') {
                previewBtn.classList.add('bg-blue-500', 'text-white');
                previewBtn.classList.remove('bg-white', 'border-gray-300');
                codeBtn.classList.add('bg-white', 'border-gray-300');
                codeBtn.classList.remove('bg-blue-500', 'text-white');
            } else {
                codeBtn.classList.add('bg-blue-500', 'text-white');
                codeBtn.classList.remove('bg-white', 'border-gray-300');
                previewBtn.classList.add('bg-white', 'border-gray-300');
                previewBtn.classList.remove('bg-blue-500', 'text-white');
            }
            renderContent();
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            if (!settings.apiKey) {
                alert('Please set your API Key in settings.');
                return;
            }
            input.value = '';
            const proj = getCurrentProject();
            proj.messages.push({ role: 'user', content: text });
            if (proj.name === 'Untitled') {
                proj.name = text.slice(0, 30) + (text.length > 30 ? '...' : '');
                renderProjects();
            }
            save();
            sendBtn.disabled = true;
            try {
                const response = await fetch(settings.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        messages: [{ role: 'system', content: SYSTEM_PROMPT }, ...proj.messages]
                    })
                });
                const respText = await response.text();
                if (!response.ok) {
                    alert("API Error: " + respText);
                    return;
                }
                const data = JSON.parse(respText);
                const content = data.choices[0].message.content;
                proj.messages.push({ role: 'assistant', content });
                save();
                renderContent();
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                sendBtn.disabled = false;
            }
        }

        // Initialize
        if (projects.length === 0 || !currentId || !projects.some(p => p.id === currentId)) {
            createNewProject();
        }
        renderProjects();
        renderContent();
        updateMode('preview');

        // Event listeners
        newProjectBtn.onclick = createNewProject;
        previewBtn.onclick = () => updateMode('preview');
        codeBtn.onclick = () => updateMode('code');
        downloadBtn.onclick = () => {
            const html = getCurrentHtml();
            if (!html) return alert('No HTML generated yet.');
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            a.click();
            URL.revokeObjectURL(url);
        };
        sendBtn.onclick = sendMessage;
        input.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };
        settingsBtn.onclick = () => {
            apiUrlInput.value = settings.apiUrl;
            apiKeyInput.value = settings.apiKey;
            modelIdInput.value = settings.model;
            modal.classList.remove('hidden');
        };
        closeModal.onclick = () => modal.classList.add('hidden');
        apiUrlInput.onchange = (e) => { settings.apiUrl = e.target.value; save(); };
        apiKeyInput.onchange = (e) => { settings.apiKey = e.target.value; save(); };
        modelIdInput.onchange = (e) => { settings.model = e.target.value; save(); };
    </script>
</body>
</html>
